import{u as x}from"./use-quasar.0c941a1e.js";import{u as R,i as v,k as O,o as E,l as q,n as F,m as N,r as n,p as s,w as P,q as b,s as M,t as j,f as H,v as I,F as U}from"./index.5175d5c0.js";import{P as A}from"./LocalStorage.208915d4.js";import{u as V}from"./use-meta.44c0b124.js";import{api as d}from"./axios.c53f7cff.js";import{n as L,i as Q,d as $}from"./myFuncts.80e53bd5.js";const p="aaSessionToken",k="aaAccessToken",z={__name:"AuthComponent",setup(D,{expose:y}){const i=x(),S=String("https://auth.symphograph.ru/");R();const m=v("isOptionsLoaded"),g=v("isTokenRefreshed"),u=v("AccessToken"),l=v("SessionToken");function f(t,e,o="90d"){i.cookies.set(t,e,{expires:o,path:"/",domain:null,sameSite:"Strict",secure:!0,httpOnly:!1}),t===k&&(d.defaults.headers.common.AccessToken=e,u.value=e,F(()=>{g.value=!0})),t===p&&(l.value=e)}function h(){d.post(String("https://auth.symphograph.ru/")+"api/register.php",{params:{authType:"default"}}).then(t=>{var e,o,a,c,r;if(!((e=t==null?void 0:t.data)!=null&&e.result))throw new Error;f(p,(a=(o=t==null?void 0:t.data)==null?void 0:o.data.SessionToken)!=null?a:""),f(k,(r=(c=t==null?void 0:t.data)==null?void 0:c.data.AccessToken)!=null?r:"")}).catch(t=>{i.notify(L(t))})}function T(){d.post(String("https://auth.symphograph.ru/")+"api/refresh.php",{params:{SessionToken:l.value,AccessToken:u.value}}).then(t=>{var e,o,a,c,r;if(!((e=t==null?void 0:t.data)!=null&&e.result))throw new Error;f(p,(a=(o=t==null?void 0:t.data)==null?void 0:o.data.SessionToken)!=null?a:""),f(k,(r=(c=t==null?void 0:t.data)==null?void 0:c.data.AccessToken)!=null?r:"")}).catch(t=>{var e;if(((e=t==null?void 0:t.response)==null?void 0:e.status)===401){h();return}i.notify(L(t))})}function w(t,e){g.value=!1,m.value=!1,d.post(String("https://auth.symphograph.ru/")+"/api/relogin.php",{params:{SessionToken:l.value,AccessToken:u.value,toAccountId:t}}).then(o=>{var a;if(!((a=o==null?void 0:o.data)!=null&&a.result))throw new Error;T()}).catch(o=>{var a,c;if(Q(o)){h();return}((c=(a=o==null?void 0:o.response)==null?void 0:a.data)==null?void 0:c.error)==="needLogin"&&$(S+"auth/"+e+"/login.php",{AccessToken:u.value,SessionToken:l.value}),i.notify(L(o))})}return y({reLogin:w}),O(()=>{console.log("auth beforeMounted"),d.defaults.headers.common.Accept="application/json"}),E(()=>{var t,e;console.log("auth Mounted"),!i.cookies.getAll()[k]||!i.cookies.getAll()[p]?h():(l.value=(t=i.cookies.getAll()[p])!=null?t:"",u.value=(e=i.cookies.getAll()[k])!=null?e:"",T())}),(t,e)=>q("",!0)}};const tt={__name:"MainLayout",setup(D){N();const y=n();s("pageSettings",y);const i=n(!1);s("isOptionsLoaded",i);const S=n(!1);s("isAccountsLoaded",S);const m=n(),g=x(),u=R(),l=n("");s("AccessToken",l);const f=n("");s("SessionToken",f);const h=n(!1);s("isTokenRefreshed",h);const T=n(!1);s("admin",T);const w=n(!1);s("progress",w);const t=n(!1);s("leftDrawerOpen",t);const e=n([]);s("Halls",e);const o=n(!1);s("editMode",o);function a(_,C){m.value.reLogin(_,C)}s("reLogin",a),P(u,_=>{A.set("lastPath",_.path)});function c(){A.set("CookieConfirm","1")}function r(){A.getItem("CookieConfirm")||g.notify({message:"\u041C\u044B \u0442\u043E\u0436\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C Cookies. \u041F\u043E\u0442\u043E\u043C\u0443 \u0447\u0442\u043E \u0431\u0435\u0437 \u043D\u0438\u0445 \u043D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442.",color:"primary",timeout:0,multiLine:!0,onDismiss:c,icon:"ion-information-circle-outline",actions:[{label:"\u041F\u043E\u043D\u044F\u0442\u043D\u043E",color:"yellow",handler:()=>{}}]})}return O(()=>{}),E(()=>{A.set("lastPath",u.path),d.defaults.headers.common.Accept="application/json",console.log("mainLayout Mounted"),r()}),V({meta:{viewport:{name:"viewport",content:"initial-scale=1, width=device-width, user-scalable=yes"},equiv:{"http-equiv":"Content-Type",content:"text/html; charset=UTF-8"}}}),(_,C)=>{const B=b("router-view");return M(),j(U,null,[H(z,{ref_key:"refAuth",ref:m},null,512),h.value?(M(),I(B,{key:0,onReLogin:m.value.reLogin},null,8,["onReLogin"])):q("",!0)],64)}}};export{tt as default};
