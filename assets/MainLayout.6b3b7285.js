import{u as x}from"./use-quasar.5324f940.js";import{u as R,i as v,k as O,o as E,l as q,n as F,m as N,r as n,p as s,w as P,q as b,s as M,t as j,f as H,v as I,F as U}from"./index.ef28cfcc.js";import{P as y}from"./LocalStorage.f6b3fd75.js";import{u as V}from"./use-meta.d65e4da6.js";import{api as h}from"./axios.c040a620.js";import{n as L,i as Q,d as $}from"./myFuncts.bc1bbbc0.js";import"./jwt-decode.esm.81f958e7.js";const k="aaSessionToken",g="aaAccessToken",z={__name:"AuthComponent",setup(D,{expose:A}){const i=x(),m=String("https://auth.symphograph.ru/");R();const S=v("isOptionsLoaded"),d=v("isTokenRefreshed"),u=v("AccessToken"),l=v("SessionToken");function r(t,e,o="90d"){i.cookies.set(t,e,{expires:o,path:"/",domain:null,sameSite:"Strict",secure:!0,httpOnly:!1}),t===g&&(h.defaults.headers.common.AccessToken=e,u.value=e,F(()=>{d.value=!0})),t===k&&(l.value=e)}function p(){h.post(String("https://auth.symphograph.ru/")+"api/register.php",{params:{authType:"default"}}).then(t=>{var e,o,a,c,f;if(!((e=t==null?void 0:t.data)!=null&&e.result))throw new Error;r(k,(a=(o=t==null?void 0:t.data)==null?void 0:o.data.SessionToken)!=null?a:""),r(g,(f=(c=t==null?void 0:t.data)==null?void 0:c.data.AccessToken)!=null?f:"")}).catch(t=>{i.notify(L(t))})}function T(){h.post(String("https://auth.symphograph.ru/")+"api/refresh.php",{params:{SessionToken:l.value,AccessToken:u.value}}).then(t=>{var e,o,a,c,f;if(!((e=t==null?void 0:t.data)!=null&&e.result))throw new Error;r(k,(a=(o=t==null?void 0:t.data)==null?void 0:o.data.SessionToken)!=null?a:""),r(g,(f=(c=t==null?void 0:t.data)==null?void 0:c.data.AccessToken)!=null?f:"")}).catch(t=>{var e;if(((e=t==null?void 0:t.response)==null?void 0:e.status)===401){p();return}i.notify(L(t))})}function w(t,e){d.value=!1,S.value=!1,h.post(String("https://auth.symphograph.ru/")+"/api/relogin.php",{params:{SessionToken:l.value,AccessToken:u.value,toAccountId:t}}).then(o=>{var a;if(!((a=o==null?void 0:o.data)!=null&&a.result))throw new Error;T()}).catch(o=>{var a,c;if(Q(o)){p();return}((c=(a=o==null?void 0:o.response)==null?void 0:a.data)==null?void 0:c.error)==="needLogin"&&$(m+"auth/"+e+"/login.php",{AccessToken:u.value,SessionToken:l.value}),i.notify(L(o))})}return A({reLogin:w}),O(()=>{console.log("auth beforeMounted"),h.defaults.headers.common.Accept="application/json"}),E(()=>{var t,e;console.log("auth Mounted"),!i.cookies.getAll()[g]||!i.cookies.getAll()[k]?p():(l.value=(t=i.cookies.getAll()[k])!=null?t:"",u.value=(e=i.cookies.getAll()[g])!=null?e:"",T())}),(t,e)=>q("",!0)}};const tt={__name:"MainLayout",setup(D){N();const A=n();s("pageSettings",A);const i=n(!1);s("isOptionsLoaded",i);const m=n(),S=x(),d=R(),u=n("");s("AccessToken",u);const l=n("");s("SessionToken",l);const r=n(!1);s("isTokenRefreshed",r);const p=n(!1);s("admin",p);const T=n(!1);s("progress",T);const w=n(!1);s("leftDrawerOpen",w);const t=n([]);s("Halls",t);const e=n(!1);s("editMode",e);function o(_,C){m.value.reLogin(_,C)}s("reLogin",o),P(d,_=>{y.set("lastPath",_.path)});function a(){y.set("CookieConfirm","1")}function c(){y.getItem("CookieConfirm")||S.notify({message:"\u041C\u044B \u0442\u043E\u0436\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C Cookies. \u041F\u043E\u0442\u043E\u043C\u0443 \u0447\u0442\u043E \u0431\u0435\u0437 \u043D\u0438\u0445 \u043D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442.",color:"primary",timeout:0,multiLine:!0,onDismiss:a,icon:"ion-information-circle-outline",actions:[{label:"\u041F\u043E\u043D\u044F\u0442\u043D\u043E",color:"yellow",handler:()=>{}}]})}return O(()=>{}),E(()=>{y.set("lastPath",d.path),h.defaults.headers.common.Accept="application/json",console.log("mainLayout Mounted"),c()}),V({meta:{viewport:{name:"viewport",content:"initial-scale=1, width=device-width, user-scalable=yes"},equiv:{"http-equiv":"Content-Type",content:"text/html; charset=UTF-8"}}}),(_,C)=>{const B=b("router-view");return M(),j(U,null,[H(z,{ref_key:"refAuth",ref:m},null,512),r.value?(M(),I(B,{key:0,onReLogin:m.value.reLogin},null,8,["onReLogin"])):q("",!0)],64)}}};export{tt as default};
