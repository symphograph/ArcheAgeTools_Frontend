import{u as M}from"./use-quasar.bc7896a7.js";import{d as F,u as x,i as L,p as s,k as O,o as R,l as E,r as n,w as N,m as P,n as v,q as b,f as j,t as U,F as H}from"./index.85a18687.js";import{P as _}from"./LocalStorage.fb478afd.js";import{u as V}from"./use-meta.946c3654.js";import{api as p}from"./axios.84dd43a9.js";import{n as C,i as I,d as Q}from"./myFuncts.325243df.js";import{m as c}from"./myAuth.dbe1fc94.js";const m="aaSessionToken",h="aaAccessToken",$=F({__name:"AuthComponent",setup(q,{expose:A}){const l=M(),y=String("https://auth.symphograph.ru/");x();const k=L("isOptionsLoaded"),g=L("isTokenRefreshed");function r(e,t,o="90d"){l.cookies.set(e,t,{expires:o,path:"/",domain:void 0,sameSite:"Strict",secure:!0,httpOnly:!1}),e===h&&(p.defaults.headers.common.AccessToken=t,c.self.AccessToken=t),e===m&&(c.self.SessionToken=t)}function f(){p.post(String("https://auth.symphograph.ru/")+"/api/register.php",{params:{method:"register",authType:"default"}}).then(e=>{var t,o,a,i,u;if(!((t=e==null?void 0:e.data)!=null&&t.result))throw new Error;r(h,(a=(o=e==null?void 0:e.data)==null?void 0:o.data.AccessToken)!=null?a:""),r(m,(u=(i=e==null?void 0:e.data)==null?void 0:i.data.SessionToken)!=null?u:""),g.value=!0}).catch(e=>{console.error(e),l.notify(C(e))})}s("register",f);function d(){p.post(String("https://auth.symphograph.ru/")+"/api/refresh.php",{params:{method:"refresh",SessionToken:c.self.SessionToken,AccessToken:c.self.AccessToken}}).then(e=>{var t,o,a,i,u;if(!((t=e==null?void 0:e.data)!=null&&t.result))throw new Error;r(m,(a=(o=e==null?void 0:e.data)==null?void 0:o.data.SessionToken)!=null?a:""),r(h,(u=(i=e==null?void 0:e.data)==null?void 0:i.data.AccessToken)!=null?u:""),g.value=!0}).catch(e=>{var t;if(((t=e==null?void 0:e.response)==null?void 0:t.status)===401){f();return}console.error(e),l.notify(C(e))})}s("refreshAccessToken",d);function S(e,t){g.value=!1,k.value=!1,p.post(String("https://auth.symphograph.ru/")+"/api/relogin.php",{params:{method:"reload",SessionToken:c.self.SessionToken,AccessToken:c.self.AccessToken,toAccountId:e}}).then(o=>{var a;if(!((a=o==null?void 0:o.data)!=null&&a.result))throw new Error;d()}).catch(o=>{var a,i;if(I(o)){f();return}((i=(a=o==null?void 0:o.response)==null?void 0:a.data)==null?void 0:i.error)==="needLogin"&&Q(y+"login/"+t+"/login.php",{AccessToken:c.self.AccessToken,SessionToken:c.self.SessionToken})})}return A({reLogin:S}),O(()=>{console.log("auth beforeMounted"),p.defaults.headers.common.Accept="application/json",c.self=new c}),R(()=>{console.log("auth Mounted"),!l.cookies.getAll()[h]||!l.cookies.getAll()[m]?f():(r(m,l.cookies.getAll()[m]),r(h,l.cookies.getAll()[h]),d())}),(e,t)=>E("",!0)}});const ee={__name:"MainLayout",setup(q){const A=n();s("pageSettings",A);const l=n(!1);s("isOptionsLoaded",l);const y=n(!1);s("isAccountsLoaded",y);const k=n(),g=M(),r=x(),f=n("");s("SessionToken",f);const d=n(!1);s("isTokenRefreshed",d);const S=n(!1);s("admin",S);const e=n(!1);s("progress",e);const t=n(!1);s("leftDrawerOpen",t);const o=n([]);s("Halls",o);const a=n(!1);s("editMode",a);function i(T,w){k.value.reLogin(T,w)}s("reLogin",i),N(r,T=>{_.set("lastPath",T.path)});function u(){_.set("CookieConfirm","1")}function D(){_.getItem("CookieConfirm")||g.notify({message:"\u041C\u044B \u0442\u043E\u0436\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C Cookies. \u041F\u043E\u0442\u043E\u043C\u0443 \u0447\u0442\u043E \u0431\u0435\u0437 \u043D\u0438\u0445 \u043D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442.",color:"primary",timeout:0,multiLine:!0,onDismiss:u,icon:"ion-information-circle-outline",actions:[{label:"\u041F\u043E\u043D\u044F\u0442\u043D\u043E",color:"yellow",handler:()=>{}}]})}return O(()=>{}),R(()=>{_.set("lastPath",r.path),p.defaults.headers.common.Accept="application/json",D(),console.log("mainLayout Mounted")}),V({meta:{viewport:{name:"viewport",content:"initial-scale=1, width=device-width, user-scalable=yes"},equiv:{"http-equiv":"Content-Type",content:"text/html; charset=UTF-8"}}}),(T,w)=>{const B=P("router-view");return v(),b(H,null,[j($,{ref_key:"refAuth",ref:k},null,512),d.value?(v(),U(B,{key:0,onReLogin:k.value.reLogin},null,8,["onReLogin"])):E("",!0)],64)}}};export{ee as default};
