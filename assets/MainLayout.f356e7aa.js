import{u as M}from"./use-quasar.d747f14e.js";import{d as B,u as b,i as L,p as n,k as x,o as O,l as R,r as s,w as F,m as N,n as v,q as P,f as j,t as U,F as H}from"./index.5f348600.js";import{P as _}from"./LocalStorage.cb419eb6.js";import{u as V}from"./use-meta.37690822.js";import{api as k}from"./axios.ddc478b8.js";import{n as C,i as I,d as Q}from"./myFuncts.8be67628.js";import{m as c}from"./myAuth.e7ed00d7.js";const m="aaSessionToken",h="aaAccessToken",$=B({__name:"AuthComponent",setup(E,{expose:A}){const l=M(),S=String("https://aa.dllib.ru/tauth/");b();const p=L("isOptionsLoaded"),g=L("isTokenRefreshed");function r(e,t,o="90d"){l.cookies.set(e,t,{expires:o,path:"/",domain:void 0,sameSite:"Strict",secure:!0,httpOnly:!1}),e===h&&(k.defaults.headers.common.AccessToken=t,c.self.AccessToken=t),e===m&&(c.self.SessionToken=t)}function f(){k.post(String("https://aa.dllib.ru/tauth/")+"/api/register.php",{params:{method:"register",authType:"default"}}).then(e=>{var t,o,a,i,u;if(!((t=e==null?void 0:e.data)!=null&&t.result))throw new Error;r(h,(a=(o=e==null?void 0:e.data)==null?void 0:o.data.AccessToken)!=null?a:""),r(m,(u=(i=e==null?void 0:e.data)==null?void 0:i.data.SessionToken)!=null?u:""),g.value=!0}).catch(e=>{console.error(e),l.notify(C(e))})}n("register",f);function d(){k.post(String("https://aa.dllib.ru/tauth/")+"/api/refresh.php",{params:{method:"refresh",SessionToken:c.self.SessionToken,AccessToken:c.self.AccessToken}}).then(e=>{var t,o,a,i,u;if(!((t=e==null?void 0:e.data)!=null&&t.result))throw new Error;r(m,(a=(o=e==null?void 0:e.data)==null?void 0:o.data.SessionToken)!=null?a:""),r(h,(u=(i=e==null?void 0:e.data)==null?void 0:i.data.AccessToken)!=null?u:""),g.value=!0}).catch(e=>{var t;if(((t=e==null?void 0:e.response)==null?void 0:t.status)===401){f();return}console.error(e),l.notify(C(e))})}n("refreshAccessToken",d);function w(e,t){g.value=!1,p.value=!1,k.post(String("https://aa.dllib.ru/tauth/")+"/api/relogin.php",{params:{method:"reload",SessionToken:c.self.SessionToken,AccessToken:c.self.AccessToken,toAccountId:e}}).then(o=>{var a;if(!((a=o==null?void 0:o.data)!=null&&a.result))throw new Error;d()}).catch(o=>{var a,i;if(I(o)){f();return}((i=(a=o==null?void 0:o.response)==null?void 0:a.data)==null?void 0:i.error)==="needLogin"&&Q(S+"login/"+t+"/login.php",{AccessToken:c.self.AccessToken,SessionToken:c.self.SessionToken})})}return A({reLogin:w}),x(()=>{console.log("auth beforeMounted"),k.defaults.headers.common.Accept="application/json",c.self=new c}),O(()=>{console.log("auth Mounted"),!l.cookies.getAll()[h]||!l.cookies.getAll()[m]?f():(r(m,l.cookies.getAll()[m]),r(h,l.cookies.getAll()[h]),d())}),(e,t)=>R("",!0)}});const ee={__name:"MainLayout",setup(E){const A=s();n("pageSettings",A);const l=s(!1);n("isOptionsLoaded",l);const S=s(!1);n("isAccountsLoaded",S);const p=s(),g=M(),r=b(),f=s("");n("SessionToken",f);const d=s(!1);n("isTokenRefreshed",d);const w=s(!1);n("admin",w);const e=s(!1);n("progress",e);const t=s(!1);n("leftDrawerOpen",t);const o=s([]);n("Halls",o);const a=s(!1);n("editMode",a);function i(T,y){p.value.reLogin(T,y)}n("reLogin",i),F(r,T=>{_.set("lastPath",T.path)});function u(){_.set("CookieConfirm","1")}function q(){_.getItem("CookieConfirm")||g.notify({message:"\u041C\u044B \u0442\u043E\u0436\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C Cookies. \u041F\u043E\u0442\u043E\u043C\u0443 \u0447\u0442\u043E \u0431\u0435\u0437 \u043D\u0438\u0445 \u043D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442.",color:"primary",timeout:0,multiLine:!0,onDismiss:u,icon:"ion-information-circle-outline",actions:[{label:"\u041F\u043E\u043D\u044F\u0442\u043D\u043E",color:"yellow",handler:()=>{}}]})}return x(()=>{}),O(()=>{_.set("lastPath",r.path),k.defaults.headers.common.Accept="application/json",q(),console.log("mainLayout Mounted")}),V({meta:{viewport:{name:"viewport",content:"initial-scale=1, width=device-width, user-scalable=yes"},equiv:{"http-equiv":"Content-Type",content:"text/html; charset=UTF-8"}}}),(T,y)=>{const D=N("router-view");return v(),P(H,null,[j($,{ref_key:"refAuth",ref:p},null,512),d.value?(v(),U(D,{key:0,onReLogin:p.value.reLogin},null,8,["onReLogin"])):R("",!0)],64)}}};export{ee as default};
