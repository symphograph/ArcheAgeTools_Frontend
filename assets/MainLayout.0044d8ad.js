import{u as R}from"./use-quasar.fb03a9a8.js";import{d as F,u as x,i as C,r as a,p as s,k as O,o as q,l as D,m as N,w as P,n as b,q as M,t as j,f as U,v as H,F as V}from"./index.be968432.js";import{P as v}from"./LocalStorage.b844722c.js";import{u as I}from"./use-meta.7ad3f80c.js";import{api as p}from"./axios.b332e97b.js";import{i as Q,d as $}from"./myFuncts.cb4da9fc.js";import{m as d}from"./myAuth.6300a6e3.js";const h="aaSessionToken",m="aaAccessToken",z=F({__name:"AuthComponent",setup(E,{expose:y}){const r=R(),S=String("https://auth.symphograph.ru/");x();const k=C("isOptionsLoaded"),_=C("isTokenRefreshed"),f=a(""),g=a("");function c(e,t,o="90d"){r.cookies.set(e,t,{expires:o,path:"/",domain:void 0,sameSite:"Strict",secure:!0,httpOnly:!1}),e===m&&(p.defaults.headers.common.AccessToken=t,f.value=t,d.self.AccessToken=t),e===h&&(g.value=t,d.self.SessionToken=t)}function l(){p.post(String("https://auth.symphograph.ru/")+"/api/register.php",{params:{method:"register",authType:"default"}}).then(e=>{var t,o,n,i,u;if(!((t=e==null?void 0:e.data)!=null&&t.result))throw new Error;c(m,(n=(o=e==null?void 0:e.data)==null?void 0:o.data.AccessToken)!=null?n:""),c(h,(u=(i=e==null?void 0:e.data)==null?void 0:i.data.SessionToken)!=null?u:"")}).catch(e=>{console.error(e)})}s("register",l);function T(){p.post(String("https://auth.symphograph.ru/")+"/api/refresh.php",{params:{method:"refresh",SessionToken:d.self.SessionToken,AccessToken:d.self.AccessToken}}).then(e=>{var t,o,n,i,u;if(!((t=e==null?void 0:e.data)!=null&&t.result))throw new Error;c(h,(n=(o=e==null?void 0:e.data)==null?void 0:o.data.SessionToken)!=null?n:""),c(m,(u=(i=e==null?void 0:e.data)==null?void 0:i.data.AccessToken)!=null?u:""),_.value=!0}).catch(e=>{var t;if(((t=e==null?void 0:e.response)==null?void 0:t.status)===401){l();return}console.error(e)})}s("refreshAccessToken",T);function w(e,t){_.value=!1,k.value=!1,p.post(String("https://auth.symphograph.ru/")+"/api/relogin.php",{params:{method:"reload",SessionToken:g.value,AccessToken:f.value,toAccountId:e}}).then(o=>{var n;if(!((n=o==null?void 0:o.data)!=null&&n.result))throw new Error;T()}).catch(o=>{var n,i;if(Q(o)){l();return}((i=(n=o==null?void 0:o.response)==null?void 0:n.data)==null?void 0:i.error)==="needLogin"&&$(S+"auth/"+t+"/login.php",{AccessToken:f.value,SessionToken:g.value})})}return y({reLogin:w}),O(()=>{console.log("auth beforeMounted"),p.defaults.headers.common.Accept="application/json",d.self=new d}),q(()=>{console.log("auth Mounted"),!r.cookies.getAll()[m]||!r.cookies.getAll()[h]?l():(c(h,r.cookies.getAll()[h]),c(m,r.cookies.getAll()[m]),T())}),(e,t)=>D("",!0)}});const te={__name:"MainLayout",setup(E){N();const y=a();s("pageSettings",y);const r=a(!1);s("isOptionsLoaded",r);const S=a(!1);s("isAccountsLoaded",S);const k=a(),_=R(),f=x(),g=a("");s("AccessToken",g);const c=a("");s("SessionToken",c);const l=a(!1);s("isTokenRefreshed",l);const T=a(!1);s("admin",T);const w=a(!1);s("progress",w);const e=a(!1);s("leftDrawerOpen",e);const t=a([]);s("Halls",t);const o=a(!1);s("editMode",o);function n(A,L){k.value.reLogin(A,L)}s("reLogin",n),P(f,A=>{v.set("lastPath",A.path)});function i(){v.set("CookieConfirm","1")}function u(){v.getItem("CookieConfirm")||_.notify({message:"\u041C\u044B \u0442\u043E\u0436\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C Cookies. \u041F\u043E\u0442\u043E\u043C\u0443 \u0447\u0442\u043E \u0431\u0435\u0437 \u043D\u0438\u0445 \u043D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442.",color:"primary",timeout:0,multiLine:!0,onDismiss:i,icon:"ion-information-circle-outline",actions:[{label:"\u041F\u043E\u043D\u044F\u0442\u043D\u043E",color:"yellow",handler:()=>{}}]})}return O(()=>{}),q(()=>{v.set("lastPath",f.path),p.defaults.headers.common.Accept="application/json",u(),console.log("mainLayout Mounted")}),I({meta:{viewport:{name:"viewport",content:"initial-scale=1, width=device-width, user-scalable=yes"},equiv:{"http-equiv":"Content-Type",content:"text/html; charset=UTF-8"}}}),(A,L)=>{const B=b("router-view");return M(),j(V,null,[U(z,{ref_key:"refAuth",ref:k},null,512),l.value?(M(),H(B,{key:0,onReLogin:k.value.reLogin},null,8,["onReLogin"])):D("",!0)],64)}}};export{te as default};
